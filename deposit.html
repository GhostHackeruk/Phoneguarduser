<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deposit • Phone Guard</title>
  <style>
    :root{--g:#00ff9d;--c:#00d4ff;--bg:#06110d;--card:#0b1c16;--mut:#9bd9c4;--err:#ff4d6d;}
    *{box-sizing:border-box;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    body{margin:0;min-height:100vh;background:radial-gradient(900px 500px at 50% 15%, rgba(0,255,157,.12), transparent 60%),
      radial-gradient(700px 380px at 50% 70%, rgba(0,212,255,.10), transparent 60%), var(--bg); color:#eafff7; display:flex; align-items:center; justify-content:center; padding:18px;}
    .wrap{width:min(520px,100%);}
    .card{background:rgba(11,28,22,.72); border:1px solid rgba(0,255,157,.18); border-radius:18px; padding:16px; box-shadow:0 0 36px rgba(0,255,157,.10), inset 0 0 60px rgba(0,212,255,.05);}
    .top{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px;}
    .brand{font-weight:900; letter-spacing:.22em; color:var(--g); font-size:20px;}
    .btn{border:none; border-radius:14px; padding:12px 14px; background:linear-gradient(90deg, rgba(0,255,157,.9), rgba(0,212,255,.9)); color:#001b10; font-weight:900; cursor:pointer;}
    .btn:disabled{opacity:.55; cursor:not-allowed;}
    .btn2{background:transparent; border:1px solid rgba(0,255,157,.25); color:#c9fff0;}
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .box{flex:1; min-width:160px; background:rgba(4,12,9,.65); border:1px solid rgba(0,255,157,.15); border-radius:14px; padding:12px;}
    .label{color:var(--mut); font-size:12px; margin-bottom:6px;}
    .val{font-size:14px; color:#eafff7; word-break:break-all;}
    .copy{margin-top:10px; width:100%;}
    .hr{height:1px; background:rgba(0,255,157,.14); margin:12px 0;}
    input,select{width:100%; padding:12px 12px; border-radius:14px; border:1px solid rgba(0,255,157,.18); background:rgba(4,12,9,.6); color:#eafff7; outline:none;}
    input::placeholder{color:rgba(189,255,238,.55);}
    .hint{font-size:12px; color:var(--mut); margin-top:6px;}
    .msg{margin-top:10px; padding:10px 12px; border-radius:14px; border:1px solid rgba(0,255,157,.18); background:rgba(4,12,9,.65); color:#c9fff0; display:none;}
    .msg.err{border-color:rgba(255,77,109,.35); color:#ffd2da;}
    .title{font-weight:900; letter-spacing:.14em; margin:0 0 8px 0; color:#bffff0;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <div class="brand">PHONE GUARD</div>
          <div class="hint" id="userInfo">Checking session…</div>
        </div>
        <button class="btn btn2" id="backBtn">← Home</button>
      </div>

      <p class="title">DEPOSIT</p>

      <div class="row">
        <div class="box">
          <div class="label">bKash</div>
          <div class="val" id="bkashNo">01881096653</div>
          <button class="btn btn2 copy" data-copy="#bkashNo">Copy bKash</button>
        </div>
        <div class="box">
          <div class="label">Nagad</div>
          <div class="val" id="nagadNo">01980030467</div>
          <button class="btn btn2 copy" data-copy="#nagadNo">Copy Nagad</button>
        </div>
        <div class="box">
          <div class="label">Rocket</div>
          <div class="val" id="rocketNo">019800304675</div>
          <button class="btn btn2 copy" data-copy="#rocketNo">Copy Rocket</button>
        </div>
      </div>

      <div class="hr"></div>

      <form id="depositForm">
        <div class="row">
          <div style="flex:1; min-width:160px;">
            <div class="label">Method</div>
            <select id="method" required>
              <option value="bKash">bKash</option>
              <option value="Nagad">Nagad</option>
              <option value="Rocket">Rocket</option>
            </select>
          </div>
          <div style="flex:1; min-width:160px;">
            <div class="label">Amount (BDT)</div>
            <input id="amount" type="number" min="10" step="1" placeholder="100" required />
          </div>
        </div>

        <div style="margin-top:10px;">
          <div class="label">Last 4 digit (Transaction / Sender)</div>
          <input id="last4" inputmode="numeric" maxlength="4" placeholder="1234" required />
          <div class="hint">Exactly 4 digit লিখবে (যেমন 1234)</div>
        </div>

        <button class="btn" id="submitBtn" type="submit" style="width:100%; margin-top:12px;">SUBMIT REQUEST</button>
        <div class="msg" id="msgBox"></div>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const userInfo = document.getElementById("userInfo");
    const msgBox = document.getElementById("msgBox");
    const form = document.getElementById("depositForm");
    const submitBtn = document.getElementById("submitBtn");

    const methodEl = document.getElementById("method");
    const amountEl = document.getElementById("amount");
    const last4El  = document.getElementById("last4");

    function showMsg(text, isErr=false){
      msgBox.textContent = text;
      msgBox.classList.toggle("err", isErr);
      msgBox.style.display = "block";
    }

    // Home button
    document.getElementById("backBtn").addEventListener("click", () => {
      window.location.href = "./home.html";
    });

    // Copy buttons (with fallback)
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        // fallback
        const t = prompt("Copy this number:", text);
        return !!t || t === "";
      }
    }
    document.querySelectorAll("[data-copy]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const sel = btn.getAttribute("data-copy");
        const text = document.querySelector(sel)?.textContent?.trim() || "";
        const ok = await copyText(text);
        showMsg(ok ? "Copied ✅" : "Copy failed ❌", !ok);
      });
    });

    // Keep only 4 digits
    last4El.addEventListener("input", ()=>{
      last4El.value = last4El.value.replace(/\D/g,"").slice(0,4);
    });

    // Auth guard + set user
    let currentUser = null;
    onAuthStateChanged(auth, (user)=>{
      if(!user){
        window.location.href = "./login.html";
        return;
      }
      currentUser = user;
      userInfo.textContent = user.email || "Logged in";
    });

    // Submit
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();

      if(!currentUser){
        showMsg("Session not ready. Reload page.", true);
        return;
      }

      const method = methodEl.value;
      const amount = Number(amountEl.value);
      const last4  = String(last4El.value || "").trim();

      if(!amount || amount < 10){
        showMsg("Amount minimum 10 দিন।", true);
        return;
      }
      if(!/^\d{4}$/.test(last4)){
        showMsg("Last 4 digit ঠিকভাবে দিন (৪ ডিজিট)।", true);
        return;
      }

      submitBtn.disabled = true;
      showMsg("Submitting…");

      try{
        await addDoc(collection(db, "depositRequests"), {
          userId: currentUser.uid,
          email: currentUser.email || "",
          method,
          amount,
          last4,
          status: "pending",
          createdAt: serverTimestamp()
        });

        showMsg("Submitted ✅ Admin verify করলে balance update হবে।");
        form.reset();
        methodEl.value = "bKash";
      }catch(err){
        console.error(err);
        showMsg("Submit failed: " + (err?.code || err?.message || "unknown"), true);
      }finally{
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
