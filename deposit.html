<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deposit • Phone Guard</title>

<style>
body{
  margin:0;
  font-family: system-ui, Arial;
  background:#050b0c;
  color:#e6fff7;
  padding:16px;
}
.box{
  max-width:460px;
  margin:auto;
  background:rgba(8,18,16,.75);
  border:1px solid rgba(0,255,160,.22);
  border-radius:18px;
  padding:16px;
}
h2{
  text-align:center;
  color:#00ffa0;
  letter-spacing:2px;
  margin-top:4px;
}
.balance{
  text-align:center;
  margin:12px 0;
  font-size:18px;
  font-weight:700;
}
.paybox{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#0b1e28;
  border-radius:14px;
  padding:12px;
  margin-top:10px;
}
.payname{
  color:#00c7ff;
  font-weight:700;
}
.paynum{
  font-size:16px;
  font-weight:700;
}
.copybtn{
  padding:8px 12px;
  border:none;
  border-radius:12px;
  background:#00ffa0;
  font-weight:700;
  cursor:pointer;
}
label{
  font-size:13px;
  opacity:.8;
}
input,select{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(0,255,160,.22);
  background:#061513;
  color:#e6fff7;
  margin-top:6px;
  font-size:15px;
}
button.submit{
  width:100%;
  padding:16px;
  border:none;
  border-radius:16px;
  background:linear-gradient(90deg,#00ffa0,#00c7ff);
  color:#00130d;
  font-weight:900;
  margin-top:14px;
  cursor:pointer;
}
.msg{
  margin-top:10px;
  font-size:14px;
  text-align:center;
}
.back{
  display:block;
  margin-top:12px;
  text-align:center;
  color:#00ffa0;
  text-decoration:none;
  font-weight:700;
}
</style>
</head>

<body>

<div class="box">
  <h2>DEPOSIT</h2>

  <div class="balance">
    Balance: ৳ <span id="balance">0</span>
  </div>

  <!-- PAYMENT NUMBERS -->
  <div class="paybox">
    <div>
      <div class="payname">bKash</div>
      <div class="paynum" id="bkashNum">01881096653</div>
    </div>
    <button class="copybtn" data-copy="bkashNum">COPY</button>
  </div>

  <div class="paybox">
    <div>
      <div class="payname">Nagad</div>
      <div class="paynum" id="nagadNum">01980030467</div>
    </div>
    <button class="copybtn" data-copy="nagadNum">COPY</button>
  </div>

  <div class="paybox">
    <div>
      <div class="payname">Rocket</div>
      <div class="paynum" id="rocketNum">019800304675</div>
    </div>
    <button class="copybtn" data-copy="rocketNum">COPY</button>
  </div>

  <!-- FORM -->
  <div style="margin-top:14px">
    <label>Payment Method</label>
    <select id="method">
      <option value="bkash">bKash</option>
      <option value="nagad">Nagad</option>
      <option value="rocket">Rocket</option>
    </select>
  </div>

  <div style="margin-top:10px">
    <label>Amount (৳)</label>
    <input type="number" id="amount" min="1" placeholder="500">
  </div>

  <div style="margin-top:10px">
    <label>Last 4 Digit</label>
    <input type="text" id="last4" maxlength="4" placeholder="1234">
  </div>

  <button class="submit" id="submitBtn">SUBMIT REQUEST</button>

  <div class="msg" id="msg"></div>

  <a href="home.html" class="back">← Back to Home</a>
</div>

<script type="module">
import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  doc, getDoc, setDoc,
  addDoc, collection,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const balanceEl = document.getElementById("balance");
const msg = document.getElementById("msg");

let currentUser = null;

// COPY buttons
document.addEventListener("click", async (e)=>{
  const btn = e.target.closest("[data-copy]");
  if(!btn) return;
  const id = btn.getAttribute("data-copy");
  const text = document.getElementById(id).textContent;
  await navigator.clipboard.writeText(text);
  msg.textContent = "Copied: " + text;
});

// Auth + load data
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    location.href="login.html";
    return;
  }
  currentUser = user;

  // Load balance
  const uref = doc(db,"users",user.uid);
  const usnap = await getDoc(uref);
  if(usnap.exists()){
    balanceEl.textContent = usnap.data().balance || 0;
  }

  // Load payment numbers (admin changeable)
  const pref = doc(db,"settings","payments");
  const psnap = await getDoc(pref);
  if(psnap.exists()){
    const d = psnap.data();
    document.getElementById("bkashNum").textContent = d.bkash;
    document.getElementById("nagadNum").textContent = d.nagad;
    document.getElementById("rocketNum").textContent = d.rocket;
  }
});

// Submit deposit
document.getElementById("submitBtn").onclick = async ()=>{
  const amount = Number(document.getElementById("amount").value);
  const last4  = document.getElementById("last4").value.trim();
  const method = document.getElementById("method").value;

  if(amount < 1){
    msg.textContent = "❌ Amount ভুল";
    return;
  }
  if(!/^[0-9]{4}$/.test(last4)){
    msg.textContent = "❌ Last 4 digit ভুল";
    return;
  }

  await addDoc(collection(db,"depositRequests"),{
    userId: currentUser.uid,
    email: currentUser.email,
    method,
    amount,
    last4,
    status:"pending",
    createdAt: serverTimestamp()
  });

  msg.textContent = "✅ Deposit request submitted (Pending)";
  document.getElementById("amount").value="";
  document.getElementById("last4").value="";
};
</script>

</body>
</html>
