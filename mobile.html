<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mobile Security Support • Phone Guard</title>

  <style>
    :root{
      --bg:#050b0a; --line:rgba(0,255,160,.14);
      --neon:#00ffa0; --neon2:#00d4ff; --text:#dffdf3; --muted:#86c9b5;
      --shadow:0 0 40px rgba(0,255,160,.10), inset 0 0 60px rgba(0,40,20,.35);
      --danger:#ff4d6d;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New", monospace;
      background:
        radial-gradient(900px 600px at 20% -10%, rgba(0,255,160,.18), transparent 55%),
        radial-gradient(700px 500px at 120% 20%, rgba(0,212,255,.16), transparent 55%),
        radial-gradient(700px 500px at 50% 120%, rgba(0,255,160,.10), transparent 55%),
        var(--bg);
      padding:18px 14px 40px;
    }
    .wrap{max-width:560px;margin:0 auto}
    .card{
      border:1px solid var(--line); border-radius:22px;
      background:rgba(0,0,0,.22); box-shadow:var(--shadow);
      padding:16px;
    }
    .brand{letter-spacing:.22em; font-weight:900; text-align:center; color:var(--neon); font-size:22px}
    .sub{margin-top:6px; text-align:center; color:var(--neon2); font-size:12px; opacity:.9}

    .pillRow{display:flex; gap:10px; flex-wrap:wrap; margin:14px 0 10px}
    .pill{
      flex:1; min-width:150px;
      border:1px solid rgba(0,255,160,.18);
      border-radius:18px;
      padding:12px 14px;
      background:rgba(0,0,0,.22);
      color:var(--text);
    }
    .pill b{color:var(--neon)}
    .pill small{display:block;color:var(--muted);margin-top:4px}

    label{display:block; margin:14px 4px 8px; color:var(--muted); font-weight:800; letter-spacing:.06em}
    .input{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(0,255,160,.22);
      background:rgba(0,0,0,.30);
      padding:14px 14px;
      color:var(--text);
      outline:none;
      font-size:16px;
    }
    .hint{margin:8px 6px 0;color:var(--muted);font-size:12px;line-height:1.35}

    .btn{
      width:100%;
      margin-top:14px;
      border:0;
      border-radius:18px;
      padding:14px 14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.10em;
      color:#03100d;
      background:linear-gradient(90deg, rgba(0,255,160,.95), rgba(0,212,255,.85));
      font-size:16px;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .msg{
      margin-top:12px;
      border-radius:16px;
      padding:12px 12px;
      border:1px solid rgba(255,77,109,.35);
      background:rgba(255,77,109,.08);
      color:#ffd6dd;
      display:none;
      line-height:1.35;
      font-weight:800;
      white-space:pre-wrap;
    }
    .ok{
      border:1px solid rgba(0,255,160,.25);
      background:rgba(0,255,160,.08);
      color:#b9ffe4;
    }

    .links{display:flex; gap:10px; margin-top:12px}
    .linkBtn{
      flex:1; text-align:center; padding:11px 12px; border-radius:14px;
      border:1px solid rgba(0,255,160,.25); color:var(--neon);
      background:transparent; text-decoration:none; font-weight:800;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">PHONE GUARD</div>
      <div class="sub">Mobile Security Support • Balance-based Buy</div>

      <div class="pillRow">
        <div class="pill">
          <b>Service:</b> Mobile Security Support
          <small>Request help for your own device/account</small>
        </div>
        <div class="pill">
          <b>Price:</b> ৳ <span id="price">3000</span>
          <small>Required balance to proceed</small>
        </div>
        <div class="pill">
          <b>Balance:</b> ৳ <span id="bal">...</span>
          <small id="who">Loading...</small>
        </div>
      </div>

      <label for="phone">Phone Number (Any Country)</label>
      <input id="phone" class="input" inputmode="tel" placeholder="+8801812345678" autocomplete="tel"/>

      <div class="hint">
        * যেকোনো দেশের নাম্বার দিতে পারবেন। Example: +8801812345678, +919876543210<br/>
        * শুধু নিজের / অনুমতি থাকা নম্বর ব্যবহার করুন।
      </div>

      <button id="buyBtn" class="btn" disabled>BUY NOW</button>

      <div id="msg" class="msg"></div>

      <div class="links">
        <a class="linkBtn" href="home.html">← Back</a>
        <a class="linkBtn" href="deposit.html">Deposit</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const PRICE = 3000;

    const balEl   = document.getElementById("bal");
    const whoEl   = document.getElementById("who");
    const phoneEl = document.getElementById("phone");
    const msgEl   = document.getElementById("msg");
    const buyBtn  = document.getElementById("buyBtn");
    const priceEl = document.getElementById("price");

    priceEl.textContent = String(PRICE);

    let currentUser = null;
    let currentBalance = 0;

    function showMsg(text, ok=false){
      msgEl.classList.toggle("ok", ok);
      msgEl.textContent = text;
      msgEl.style.display = "block";
    }
    function hideMsg(){
      msgEl.style.display = "none";
      msgEl.classList.remove("ok");
      msgEl.textContent = "";
    }

    function cleanPhone(v){
      return (v || "").trim().replace(/\s+/g,"");
    }
    function isValidPhone(v){
      // + and digits only, length 8-20
      if (!v) return false;
      if (v.length < 8 || v.length > 20) return false;
      return /^\+?[0-9]+$/.test(v);
    }

    async function loadBalance(uid){
      const snap = await getDoc(doc(db, "users", uid));
      if (!snap.exists()) return 0;
      const b = Number(snap.data()?.balance || 0);
      return Number.isFinite(b) ? b : 0;
    }

    // ✅ Page load এ balance auto-load (home page এর মতো)
    onAuthStateChanged(auth, async (user) => {
      hideMsg();

      if (!user) {
        currentUser = null;
        currentBalance = 0;
        balEl.textContent = "0";
        whoEl.textContent = "Not signed in";
        buyBtn.disabled = true;

        // login না থাকলে পাঠিয়ে দিচ্ছি
        location.href = "login.html";
        return;
      }

      currentUser = user;
      whoEl.textContent = user.email || "Signed in";
      buyBtn.disabled = true;
      balEl.textContent = "...";

      try{
        currentBalance = await loadBalance(user.uid);
        balEl.textContent = String(currentBalance);
      }catch(e){
        console.error(e);
        currentBalance = 0;
        balEl.textContent = "0";
        showMsg("Balance load হচ্ছে না। Firestore rules / net check করুন।");
      }finally{
        buyBtn.disabled = false;
      }
    });

    buyBtn.addEventListener("click", async () => {
      hideMsg();

      if (!currentUser){
        showMsg("Please login first.");
        location.href = "login.html";
        return;
      }

      const phone = cleanPhone(phoneEl.value);

      if (!isValidPhone(phone)){
        showMsg("Valid phone number দিন। Example: +8801812345678");
        return;
      }

      // ✅ Fresh balance check (safe)
      buyBtn.disabled = true;
      buyBtn.textContent = "Checking...";

      try{
        currentBalance = await loadBalance(currentUser.uid);
        balEl.textContent = String(currentBalance);
      }catch(e){
        console.error(e);
      }

      if (currentBalance < PRICE){
        showMsg("Insufficient balance — আগে টাকা এড করুন");
        buyBtn.disabled = false;
        buyBtn.textContent = "BUY NOW";
        return;
      }

      showMsg("Balance OK ✅ Next page এ যাচ্ছে...", true);

      const url =
        "next.html?type=mobile" +
        "&phone=" + encodeURIComponent(phone) +
        "&price=" + encodeURIComponent(String(PRICE));

      setTimeout(() => { location.href = url; }, 350);
    });
  </script>
</body>
</html>
